---
title: "PhotoDraw-Analysis1"
author: "Bria Long"
date: "8/6/2018"
output: html_document
---

```{r setup, echo = FALSE}
library(knitr)
opts_chunk$set(echo = TRUE)
library(tidyverse)
library(assertthat)
library(ggthemes)
library(lme4)
library(langcog)
theme_set(theme_few())
```

## Load data and do basic preprocessing.
```{r}
## Read in data outputs from turk data - true/false recognition 
r <- read.csv("preprocessed_data/photodraw_recognition_ratings.csv") %>%
  as.tibble() 

## refactor levels to that semantic condition is first, then working memory, then perception
r$condition <- factor(r$condition, levels = c("S", "W", "P"))

d <- read_csv("preprocessed_data/photodraw_data_Aug1.csv") %>%
  select(-X1) %>%
  filter(!is.na(age)) %>%
  mutate(imNameShort = paste0(category, '_sketch', '_', session_id,'_',condition, '_', age,'.png'))

```
### Convert alphanumeric age to numeric age in python csv
```{r}
d <- d %>%
  group_by(session_id) %>%
  mutate(age_char = strsplit(age,"e")[[1]][2]) %>%
  mutate(age_num = as.numeric(age_char)) %>%
  select(-age) %>%
  rename(age = age_num)
```

## Join ratings and python datasets
```{r}
joined <- left_join(r,d)
```

### Look at num strokes / duration per condition
```{r}
ggplot(d, aes(x = condition, y = num_strokes, col=age)) + 
    geom_jitter(width = .1, alpha = .5) 
    # scale_color_brewer(viridis)

ggplot(d, aes(x = condition, y = draw_duration, col=age)) +
    geom_jitter(width = .1, alpha = .5) 

```

## How do num strokes / draw duration relate to recognizability?
```{r}
corByItem <- joined %>%
  group_by(imNameShort) %>%
  mutate(avgCorrect = mean(correct)) %>%
  distinct(imNameShort, avgCorrect, draw_duration, num_strokes, age, condition)

```

# Make some diagnostic plots...
```{r}
ggplot(corByItem, aes(x = num_strokes, y = avgCorrect, col=condition)) +
    geom_jitter(width = .1, alpha = .5) +
    facet_grid(~age)

ggplot(corByItem, aes(x = draw_duration, y = avgCorrect, col=condition)) +
    geom_jitter(width = .1, alpha = .5) +
    facet_grid(~age)
```

## Sanity check number of raters per image
```{r}
ratersPerImage <- r %>%
  distinct(imageName, workerid) %>%
  group_by(imageName) %>%
  summarize(count = n()) 

assert_that(sum(ratersPerImage$count==30)==(length(unique(r$imageName))))

```

## Sanity check number of kids in each condition and age
```{r}
r %>%
  distinct(sessionId, condition, age) %>%
  group_by(condition) %>%
  summarize(count = n()) %>%
  kable()
```

## And distribution across age groups and conditions
```{r}
r %>%
  distinct(sessionId, condition, age) %>%
  group_by(condition,age) %>%
  summarize(count = n()) 
```

## Take a look at the raw rating data as a sanity check
Highest chosen category is correct one;  confusions look more or less reasonable.
```{r}
ratingConfusions <- r %>%
  group_by(category, rating)  %>%
  summarize(number = n()) %>%
  group_by(category) %>%
  mutate(prop = number / sum(number)) %>%
  complete(rating, fill = list(prop = 0))

ggplot(ratingConfusions, 
       aes(x = rating, y = category, fill = prop)) + 
  geom_tile() + 
  ylab("True Category") + 
  xlab("Rated as") + 
  scale_fill_gradient(limits = c(0, 1)) + 
  theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = .5))
```

## How different are individual participants?
```{r}

corbyChild <- r %>%
  group_by(sessionId) %>%
  multi_boot_standard(col = "correct")

indiv <- left_join(r,corbyChild) %>%
  mutate(sessionId = fct_reorder(sessionId, mean, .desc=TRUE))

ggplot(indiv, aes(x = sessionId, y = mean, col = age)) +
  geom_jitter(width = .1, alpha = .5) + 
  theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = .5))
```


##  How does recognizability vary across  condition only?
```{r}
## Get the percent recognized for each age group / condition
corbyConditionOnly <- r %>%
  group_by(condition) %>%
  multi_boot_standard(col = "correct")  

ggplot(corbyConditionOnly, aes(x = condition, y = mean, col=condition)) + 
  geom_pointrange(aes(ymin = ci_lower, ymax = ci_upper))  

```



##  How does recognizability vary across age and condition, collapsing across items?
```{r}
## Get the percent recognized for each age group / condition
corbyCondition <- r %>%
  group_by(condition,age) %>%
  multi_boot_standard(col = "correct")  

ggplot(corbyCondition, aes(x = age, y = mean, col=age)) + 
  geom_pointrange(aes(ymin = ci_lower, ymax = ci_upper)) +
  facet_grid(~condition) 
```


```{r}
corbyChild <- r %>%
  group_by(condition,sessionId, age) %>%
  mutate(avgCorrect = mean(correct))

ggplot(corbyChild, aes(x = age, y = avgCorrect, col=age)) + 
  geom_jitter(width = .05, alpha = .5)  +
  facet_grid(~condition) 
  
```
## How does this trend break down by the catergory that children drew?
```{r}
corbyItem <- r %>%
  group_by(age,condition,category) %>%
  multi_boot_standard(col = "correct")  

ggplot(corbyItem, aes(x = condition, y = mean, col=age)) + 
  geom_pointrange(aes(ymin = ci_lower, ymax = ci_upper)) +
  facet_wrap(~category) 
```


## Plot effects for each individual subject
```{r}

corbyChild <- r %>%
  group_by(sessionId)%>%
  mutate(meanCorrect = mean(correct))

ggplot(corbyChild, aes(x = condition, y = meanCorrect, col=age)) + 
  geom_point() 
```

```{r}
r$workerid = as.factor(r$workerid)
corbyWorked <- r %>%
  group_by(workerid) %>%
  mutate(avgCorrect = mean(correct)) %>%
  distinct(workerid, avgCorrect) 

ggplot(corbyItem, aes(x = condition, y = mean, col=age)) + 
  geom_pointrange(aes(ymin = ci_lower, ymax = ci_upper)) +
  facet_wrap(~category) 
```

# Non-linear mixed effect model with random slopes for items and random intercepts for participants. 
```{r}
mod <- glmer(correct ~ age*condition + (1 | sessionId) + (1 | category),  data = r,  family = "binomial")
kable(summary(mod)$coef, digits = 3)
```

### Exploratory analysis: We have a somewhat uneven distribution of kids across ages (though even across condition). Do these results hold when we bin by "younger" and "older" kids to get a more even split?
```{r}
r <- r %>%
  mutate(age_group = cut(age, c(3.9, 5, 8), labels = c("4-5","6-7"))) 
mod_age_group <- glmer(correct ~ age_group*condition + (1 | sessionId) + (1 | category),  data = r,  family = "binomial")
kable(summary(mod_age_group)$coef, digits = 3)
```

### Plot how accuracy differs by age group and condition
```{r}
corbyAgeGroup <- r %>%
  group_by(age_group, condition)%>%
  multi_boot_standard(col="correct")

ggplot(corbyAgeGroup, aes(x = condition, y = mean, col=age_group)) + 
  geom_pointrange(aes(ymin = ci_lower, ymax = ci_upper))


```

Looks like we still see an interaction between age_group and condition, though the main effect of 4-5 year-olds and 6-7 year-olds is no longer significant on it's own.
```{r}
W_average = round(corbyConditionOnly$mean[corbyConditionOnly$condition=="W"],2)
P_average = round(corbyConditionOnly$mean[corbyConditionOnly$condition=="P"],2)
S_average = round(corbyConditionOnly$mean[corbyConditionOnly$condition=="S"],2)

```

Overall, we found that children in the perception condition actually drew the least recongizble drawings (perception condition M =`r P_average`% recognized, semantic condition, M=`r S_average`%, working memory condition, M=`r W_average`%).

